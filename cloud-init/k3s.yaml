runcmd:
  # INSTALL_K3S_VERSION=v1.24.7+k3s1 for Consul-K8S <=0.49.0 compatibility
  - curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.24.7+k3s1 INSTALL_K3S_EXEC='server --flannel-backend=host-gw' sh -s -
  - mkdir -p /home/ubuntu/.kube/
  - cp /etc/rancher/k3s/k3s.yaml /home/ubuntu/.kube/config
  - chown ubuntu:ubuntu /home/ubuntu/.kube/config
  - k3s completion bash > /etc/bash_completion.d/k3s
  - echo "export KUBECONFIG=/home/ubuntu/.kube/config" | tee -a /home/ubuntu/.bashrc
  - echo "alias k=\'kubectl\'" | tee -a /home/ubuntu/.bashrc

  - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash 
  - helm completion bash > /etc/bash_completion.d/helm

  - kubectl completion bash > /etc/bash_completion.d/kubectl
  - curl -sL "https://releases.hashicorp.com/consul-k8s/0.49.0/consul-k8s_0.49.0_linux_$( [ $(uname -m) = aarch64 ] && echo arm64 || echo amd64).zip" | zcat > /usr/local/bin/consul-k8s
  - chmod +x /usr/local/bin/consul-k8s

write_files:
  - path: /home/ubuntu/static-client.yaml
    defer: true
    encoding: base64
    content: |
      YXBpVmVyc2lvbjogdjEKa2luZDogU2VydmljZUFjY291bnQKbWV0YWRhdGE6CiAgbmFtZTogc3Rh
      dGljLWNsaWVudAotLS0KYXBpVmVyc2lvbjogdjEKa2luZDogU2VydmljZQptZXRhZGF0YToKICBu
      YW1lOiBzdGF0aWMtY2xpZW50CnNwZWM6CiAgc2VsZWN0b3I6CiAgICBhcHA6IHN0YXRpYy1jbGll
      bnQKICBwb3J0czoKICAgIC0gcG9ydDogNDMyMQogICAgICB0YXJnZXRQb3J0OiA0MzIxCi0tLQph
      cGlWZXJzaW9uOiBhcHBzL3YxCmtpbmQ6IERlcGxveW1lbnQKbWV0YWRhdGE6CiAgbGFiZWxzOgog
      ICAgYXBwOiBzdGF0aWMtY2xpZW50CiAgbmFtZTogc3RhdGljLWNsaWVudApzcGVjOgogIHJlcGxp
      Y2FzOiAxCiAgc2VsZWN0b3I6CiAgICBtYXRjaExhYmVsczoKICAgICAgYXBwOiBzdGF0aWMtY2xp
      ZW50CiAgdGVtcGxhdGU6CiAgICBtZXRhZGF0YToKICAgICAgYW5ub3RhdGlvbnM6CiAgICAgICAg
      Y29uc3VsLmhhc2hpY29ycC5jb20vY29ubmVjdC1pbmplY3Q6ICd0cnVlJwogICAgICAgIGNvbnN1
      bC5oYXNoaWNvcnAuY29tL3RyYW5zcGFyZW50LXByb3h5OiAnZmFsc2UnCiAgICAgICAgY29uc3Vs
      Lmhhc2hpY29ycC5jb20vY29ubmVjdC1zZXJ2aWNlLXVwc3RyZWFtczogJ3N0YXRpYy1zZXJ2ZXI6
      ODA4MDprM3MtdXMnCiAgICAgIGxhYmVsczoKICAgICAgICBhcHA6IHN0YXRpYy1jbGllbnQKICAg
      IHNwZWM6CiAgICAgIHNlcnZpY2VBY2NvdW50TmFtZTogc3RhdGljLWNsaWVudAogICAgICBjb250
      YWluZXJzOgogICAgICAgIC0gbmFtZTogc3RhdGljLWNsaWVudAogICAgICAgICAgaW1hZ2U6IGN1
      cmxpbWFnZXMvY3VybDo3Ljc3LjAKICAgICAgICAgIHBvcnRzOgogICAgICAgICAgICAtIGNvbnRh
      aW5lclBvcnQ6IDQzMjEKICAgICAgICAgIGNvbW1hbmQ6IFsnL2Jpbi9zaCcsICctYycsICctLSdd
      CiAgICAgICAgICBhcmdzOiBbJ3doaWxlIHRydWU7IGRvIHNsZWVwIDMwOyBkb25lOyddCgo=

  - path: /home/ubuntu/static-server.yaml
    defer: true
    encoding: base64
    content: |
      YXBpVmVyc2lvbjogdjEKa2luZDogU2VydmljZUFjY291bnQKbWV0YWRhdGE6CiAgbmFtZTogc3Rh
      dGljLXNlcnZlcgotLS0KYXBpVmVyc2lvbjogdjEKa2luZDogU2VydmljZQptZXRhZGF0YToKICBu
      YW1lOiBzdGF0aWMtc2VydmVyCnNwZWM6CiAgc2VsZWN0b3I6CiAgICBhcHA6IHN0YXRpYy1zZXJ2
      ZXIKICBwb3J0czoKICAgIC0gcG9ydDogMTIzNAogICAgICB0YXJnZXRQb3J0OiA4MDgwCi0tLQph
      cGlWZXJzaW9uOiBhcHBzL3YxCmtpbmQ6IERlcGxveW1lbnQKbWV0YWRhdGE6CiAgbGFiZWxzOgog
      ICAgYXBwOiBzdGF0aWMtc2VydmVyCiAgbmFtZTogc3RhdGljLXNlcnZlcgpzcGVjOgogIHJlcGxp
      Y2FzOiAxCiAgc2VsZWN0b3I6CiAgICBtYXRjaExhYmVsczoKICAgICAgYXBwOiBzdGF0aWMtc2Vy
      dmVyCiAgdGVtcGxhdGU6CiAgICBtZXRhZGF0YToKICAgICAgYW5ub3RhdGlvbnM6CiAgICAgICAg
      Y29uc3VsLmhhc2hpY29ycC5jb20vY29ubmVjdC1pbmplY3Q6ICd0cnVlJwogICAgICBsYWJlbHM6
      CiAgICAgICAgYXBwOiBzdGF0aWMtc2VydmVyCiAgICBzcGVjOgogICAgICBzZXJ2aWNlQWNjb3Vu
      dE5hbWU6IHN0YXRpYy1zZXJ2ZXIKICAgICAgY29udGFpbmVyczoKICAgICAgICAtIG5hbWU6IHN0
      YXRpYy1zZXJ2ZXIKICAgICAgICAgIGltYWdlOiB2aWozc2gvaHR0cC1lY2hvOjEuMC4wCiAgICAg
      ICAgICBhcmdzOgogICAgICAgICAgICAtIC10ZXh0PSJoZWxsbyB3b3JsZCIKICAgICAgICAgICAg
      LSAtbGlzdGVuPTo4MDgwCiAgICAgICAgICBwb3J0czoKICAgICAgICAgICAgLSBjb250YWluZXJQ
      b3J0OiA4MDgwCiAgICAgICAgICAgICAgbmFtZTogaHR0cAoK

  - path: /home/ubuntu/service-intention.yaml
    defer: true
    encoding: base64
    content: |
      YXBpVmVyc2lvbjogY29uc3VsLmhhc2hpY29ycC5jb20vdjFhbHBoYTEKa2luZDogU2VydmljZUlu
      dGVudGlvbnMKbWV0YWRhdGE6CiAgbmFtZTogc3RhdGljLWNsaWVudC10by1zdGF0aWMtc2VydmVy
      CnNwZWM6CiAgZGVzdGluYXRpb246CiAgICBuYW1lOiBzdGF0aWMtc2VydmVyCiAgc291cmNlczoK
      ICAgIC0gbmFtZTogc3RhdGljLWNsaWVudAogICAgICBhY3Rpb246IGFsbG93Cgo=

  - path: /home/ubuntu/proxy-defaults.yaml
    defer: true
    encoding: base64
    content: |
      YXBpVmVyc2lvbjogY29uc3VsLmhhc2hpY29ycC5jb20vdjFhbHBoYTEKa2luZDogUHJveHlEZWZh
      dWx0cwptZXRhZGF0YToKICBuYW1lOiBnbG9iYWwKc3BlYzoKICBtZXNoR2F0ZXdheToKICAgIG1v
      ZGU6IGxvY2FsCiAgY29uZmlnOgogICAgcHJvdG9jb2w6IGh0dHAK
